// (c) 2014 Amherst College. Author: Aaron Coburn <acoburn@amherst.edu>
(function(){var t,e,r,n,a,s,i,u,o,l,c,p,d,g,h,f={}.hasOwnProperty,m=function(t,e){function r(){this.constructor=t}for(var n in e)f.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},y=function(t,e){return function(){return t.apply(e,arguments)}};e={solr:"/solr/lgbt/select?",search_params:{wt:"json",sort:"start desc",stats:"true","stats.field":"start"},packing:4,rows:30},h=function(t){var r;return r=jQuery.param(_.defaults(t,e.search_params)),""+e.solr+r},r=["January","February","March","April","May","June","July","August","September","October","November","December"],g=function(t,e){var n,a,s;return s=new Date(t),n=new Date(e),a=""+r[s.getUTCMonth()]+" "+s.getUTCDate(),a+=n.getUTCFullYear()===s.getUTCFullYear()?n.getUTCMonth()===s.getUTCMonth()?n.getUTCDate()===s.getUTCDate()?", "+s.getUTCFullYear():" - "+n.getUTCDate()+", "+s.getUTCFullYear():" - "+r[n.getUTCMonth()]+" "+n.getUTCDate()+", "+n.getFullYear():", "+s.getUTCFullYear()+" - "+r[n.getUTCMonth()]+" "+n.getUTCDate()+", "+n.getUTCFullYear()},l=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return m(r,t),r.prototype.offset=function(){return this.get("data").length+this.get("start")},r.prototype.is_proper_subset=function(){var t,e;return t=this.get("extent"),t?(e=t.map(function(t){return t.toISOString()}),e[0]===this.get("min").toISOString()&&e[1]===this.get("max").toISOString()?!1:!0):!1},r.prototype.build_results=function(t,r){return $.get(h({q:t,start:r*e.rows,rows:e.rows}),function(t){return function(r){return t.set(r.response.numFound?{min:new Date(r.stats.stats_fields.start.min),max:new Date(r.stats.stats_fields.start.max),start:r.response.start,count:r.response.numFound,index:_.indexBy(r.response.docs,"id"),extent:d3.extent(r.response.docs.map(function(t){return new Date(t.start)})),data:r.response.docs.map(function(t,r){return{id:t.id,pos:r%e.packing,v:t._version_,date:new Date(t.start),progress:t.progress,title:t.title}}).reverse()}:{min:null,max:null,start:0,count:0,index:{},data:[],extent:null})}}(this))},r}(Backbone.Model),c=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return m(e,t),e.prototype.build_summary=function(t){return $.get(h({q:t,rows:0,facet:!0,"facet.field":"year","facet.mincount":1}),function(t){return function(e){var r;return r=e.facet_counts.facet_fields.year.map(function(t){return parseInt(t,10)}),t.set({data:_.zip.apply(null,_.partition(r,function(t,e){return e%2===0}))})}}(this))},e}(Backbone.Model),u=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return m(e,t),e.prototype.defaults={q:null,filters:[],page:0},e.prototype.prev=function(){return this.set("page",this.get("page")+1)},e.prototype.next=function(){return this.set("page",this.get("page")-1)},e}(Backbone.Model),i=function(e){function r(){return this.render=y(this.render,this),r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.initialize=function(){return t.results.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.results.offset()<t.results.get("count")?$("#prev-tpl").html():"<div></div>")},r.prototype.events={click:function(){return t.results.offset()<t.results.get("count")&&t.query.prev(),t.results.build_results(t.query.get("q"),t.query.get("page"))}},r}(Backbone.View),s=function(e){function r(){return this.render=y(this.render,this),r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.initialize=function(){return t.results.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.results.get("start")>0?$("#next-tpl").html():"<div></div>")},r.prototype.events={click:function(){return t.results.get("start")>0&&t.query.next(),t.results.build_results(t.query.get("q"),t.query.get("page"))}},r}(Backbone.View),a=function(e){function r(){return this.render=y(this.render,this),r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.initialize=function(){return t.selected.on("change",this.render)},r.prototype.render=function(){var e;return t.selected.get("id")?(e=t.selected.toJSON(),e.date_string=g(e.start,e.end),e.locations=_.zip(e.municipality,e.country,e.region).map(function(t){return _.compact(t).join(", ")}),e.media_uri&&_.head(e.media_uri).match(/\.jpe?g/i)&&(e.media=[{url:_.head(e.media_uri).replace(/image:/,""),caption:e.media_caption,credit:e.media_credit,title:e.media_title}]),e.sources=_.zip(e.source_citation,e.source_title,e.source_url).map(function(t){return{citation:t[0]||t[1],title:t[1],url:t[2]}}),this.$el.html(Mustache.render($("#selected-modal-tpl").html(),e)),this.$(".modal").modal({show:!0,backdrop:!0})):this.$el.html("")},r.prototype.events={"hidden.bs.modal .modal":function(){return t.selected.clear()}},r}(Backbone.View),p=function(e){function r(){return this.render=y(this.render,this),r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.initialize=function(){return t.results.on("change:extent",this.render),t.stats.on("change",this.render),$(window).resize(_.debounce(this.render,300))},r.prototype.render=function(){var e,r,n,a,s,i,u,o,l,c,p,d;return t.stats.get("data")&&(i=15,n=t.stats.get("data").map(function(t){return{date:new Date(t[0],1),value:t[1]}}),this.$el.html("<svg></svg>"),c=d3.select(this.$el.find("svg")[0]),a=this.$el.height()-25,p=d3.time.scale().domain([d3.min(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([20,this.$el.width()-20]),d=d3.scale.linear().domain([0,d3.max(n.map(function(t){return t.value}))]).range([a,0]),r=c.append("g").attr("class","context"),l=d3.scale.linear().domain([1,d3.max(n.map(function(t){return t.value}))]).range([2,i]),r.selectAll("rect").data(n.filter(function(t){return t.value>0})).enter().append("rect").attr("transform","translate(0, 10)").attr("x",function(t){return-1+p(t.date)}).attr("width",2).attr("y",function(t){return a/2-l(t.value)}).attr("height",function(t){return 2*l(t.value)}),e=d3.svg.axis().scale(p).orient("bottom"),r.append("g").attr("class","x axis").attr("transform","translate(0, "+a+")").call(e),t.results.is_proper_subset())?(o=6,u=t.results.get("extent")[0],s=t.results.get("extent")[1],r.append("g").attr("class","x brush").append("rect").attr("transform","translate(0, "+(a/2-i)+")").attr("y",0).attr("height",2*i+20).attr("x",p(u)-5).attr("width",p(s)-p(u)+10)):void 0},r}(Backbone.View),o=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.events={"click .fa-search":function(){return this.$("form").submit()},"submit form":function(){var e;return e=this.$("input").val().trim(),t.query.set({q:e.length?e:"*",filters:[],page:0}),this.$("input").blur(),t.results.build_results(t.query.get("q"),0),t.stats.build_summary(t.query.get("q")),!1}},r}(Backbone.View),n=function(e){function r(){return this.render=y(this.render,this),r.__super__.constructor.apply(this,arguments)}return m(r,e),r.prototype.initialize=function(){return t.query.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.query.get("q"))},r}(Backbone.View),d=function(r){function n(){return this.render=y(this.render,this),n.__super__.constructor.apply(this,arguments)}return m(n,r),n.prototype.initialize=function(){return t.results.on("change",this.render),$(window).resize(_.debounce(this.render,300))},n.prototype.render=function(){var r,n,a,s,i,u,o,l,c,p,d;return u=25,a=t.results.get("data"),this.$el.html("<svg></svg>"),a.length?(i=this.$el.height()-u,s=.75*i/e.packing,p=d3.time.scale().domain([d3.min(a.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(a.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([u,this.$el.width()-u]),d=d3.scale.linear().domain(d3.extent(a.map(function(t){return t.pos}))).range([i-s/2-u,s/2+u]),l=d3.select(this.$el.find("svg")[0]),n=l.append("g").attr("class","context"),c=d3.tip().attr("class","tooltip").offset([-10,0]).html(function(t){return t.title}),l.call(c),o=d3.scale.linear().domain([1,d3.max(a.map(function(t){return t.value}))]).range([2,15]),n.selectAll("circle").data(a).enter().append("circle").attr("data-title",function(t){return t.title}).attr("data-id",function(t){return t.id}).attr("transform","translate(0, 10)").attr("fill",function(t){switch(t.progress){case"Forwards":return"green";case"Backwards":return"red";default:return"black"}}).attr("cx",function(t){return p(t.date)}).attr("cy",function(t){return d(t.pos)+t.v%s-s/2}).attr("r",5).on("mouseover",c.show).on("mouseout",c.hide).on("click",c.hide),r=d3.svg.axis().scale(p).orient("bottom"),n.append("g").attr("class","x axis").attr("transform","translate(0, "+i+")").call(r)):void 0},n.prototype.events={"click circle":function(e){return t.selected.set(t.results.get("index")[$(e.target).data("id")])}},n}(Backbone.View),t={query:new u({q:"*"}),results:new l,stats:new c,selected:new Backbone.Model,preview:new Backbone.Model},$(function(){return new o({el:"header"}),new d({el:"#timeline"}),new p({el:"#summary"}),new a({el:"#selected"}),new i({el:"#prev"}),new s({el:"#next"}),t.results.build_results(t.query.get("q"),t.query.get("page")),t.stats.build_summary(t.query.get("q"))})}).call(this);