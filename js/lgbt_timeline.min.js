// (c) 2014 Amherst College. Author: Aaron Coburn <acoburn@amherst.edu>
(function(){var t,e,r,n,o,a,i,s,u,c,l,p,d,g,h,f,m={}.hasOwnProperty,y=function(t,e){function r(){this.constructor=t}for(var n in e)m.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},v=function(t,e){return function(){return t.apply(e,arguments)}};e=e||{},f=function(t){var e;return e=jQuery.param(_.defaults(t,Config.search_params)),""+Config.solr+e},n=["January","February","March","April","May","June","July","August","September","October","November","December"],h=function(t,e){var r,o,a;return a=new Date(t),r=new Date(e),o=""+n[a.getUTCMonth()]+" "+a.getUTCDate(),o+=r.getUTCFullYear()===a.getUTCFullYear()?r.getUTCMonth()===a.getUTCMonth()?r.getUTCDate()===a.getUTCDate()?", "+a.getUTCFullYear():" - "+r.getUTCDate()+", "+a.getUTCFullYear():" - "+n[r.getUTCMonth()]+" "+r.getUTCDate()+", "+r.getFullYear():", "+a.getUTCFullYear()+" - "+n[r.getUTCMonth()]+" "+r.getUTCDate()+", "+r.getUTCFullYear()},l=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.offset=function(){return this.get("data").length+this.get("start")},r.prototype.is_proper_subset=function(){var t,e;return t=this.get("extent"),t?(e=t.map(function(t){return t.toISOString()}),e[0]===this.get("min").toISOString()&&e[1]===this.get("max").toISOString()?!1:!0):!1},r.prototype.parse=function(t){return t.response.numFound?{min:new Date(t.stats.stats_fields.start.min),max:new Date(t.stats.stats_fields.start.max),start:t.response.start,count:t.response.numFound,index:_.indexBy(t.response.docs,"id"),extent:d3.extent(t.response.docs.map(function(t){return new Date(t.start)})),data:t.response.docs.map(function(t,e){return{id:t.id,pos:e,v:t._version_,date:new Date(t.start),progress:t.progress,category:_.head(t.category),title:t.title}}).reverse()}:{min:null,max:null,start:0,count:0,index:{},data:[],extent:null}},r.prototype.urlRoot=function(){return f({q:e.query.get("q")||"*",start:e.query.get("page")*Config.rows,rows:Config.rows})},r}(Backbone.Model),p=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.urlRoot=function(){return f({q:e.query.get("q")||"*",rows:0,facet:!0,"facet.field":"year","facet.mincount":1})},r.prototype.parse=function(t){var e;return e=t.facet_counts.facet_fields.year.map(function(t){return parseInt(t,10)}),{data:_.zip.apply(null,_.partition(e,function(t,e){return e%2===0}))}},r}(Backbone.Model),u=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.defaults={q:null,filters:{},page:0},e.prototype.prev=function(){return this.set("page",this.get("page")+1)},e.prototype.next=function(){return this.set("page",this.get("page")-1)},e}(Backbone.Model),r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.model=Backbone.Model,e.prototype.parse=function(t){var e;return e=t.facet_counts.facet_fields.category.filter(function(t,e){return e%2===0}),e.map(function(t){return{catagory:t}})},e.prototype.url=f({q:"*",rows:0,facet:!0,"facet.field":"category","facet.mincount":1}),e}(Backbone.Collection),t=function(t){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.initialize=function(){return e.results.on("change",this.render)},r.prototype.render=function(){return this.$el.html(this.show_step()?$(this.tpl).html():this.$el.html("<div></div>"))},r.prototype.events={click:function(){return this.step(),e.results.fetch()}},r}(Backbone.View),i=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.show_step=function(){return e.results.get("start")>0},r.prototype.step=function(){return e.results.get("start")>0?e.query.next():void 0},r.prototype.tpl="#next-tpl",r}(t),s=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.show_step=function(){return e.results.offset()<e.results.get("count")},r.prototype.step=function(){return e.results.offset()<e.results.get("count")?e.query.prev():void 0},r.prototype.tpl="#prev-tpl",r}(t),a=function(t){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.initialize=function(){return e.selected.on("change",this.render)},r.prototype.render=function(){var t;return e.selected.get("id")?(t=e.selected.toJSON(),t.date_string=h(t.start,t.end),t.locations=_.zip(t.municipality,t.country,t.region).map(function(t){return _.compact(t).join(", ")}),t.media_uri&&_.head(t.media_uri).match(/\.jpe?g/i)&&(t.media=[{url:_.head(t.media_uri).replace(/image:/,""),caption:t.media_caption,credit:t.media_credit,title:t.media_title}]),t.sources=_.zip(t.source_citation,t.source_title,t.source_url).map(function(t){return{citation:t[0]||t[1],title:t[1],url:t[2]}}),this.$el.html(Mustache.render($("#selected-modal-tpl").html(),t)),this.$(".modal").modal({show:!0,backdrop:!0})):this.$el.html("")},r.prototype.events={"hidden.bs.modal .modal":function(){return e.selected.clear()}},r}(Backbone.View),d=function(t){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.initialize=function(){return e.results.on("change:extent",this.render),e.stats.on("change",this.render),$(window).resize(_.debounce(this.render,300))},r.prototype.render=function(){var t,r,n,o,a,i,s,u,c,l,p,d;return e.stats.get("data")&&(i=15,n=e.stats.get("data").map(function(t){return{date:new Date(t[0],1),value:t[1]}}),this.$el.html("<svg></svg>"),l=d3.select(this.$el.find("svg")[0]),o=this.$el.height()-25,p=d3.time.scale().domain([d3.min(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([20,this.$el.width()-20]),d=d3.scale.linear().domain([0,d3.max(n.map(function(t){return t.value}))]).range([o,0]),l.on("click",function(){return console.log(p.invert(d3.mouse(this)[0]+10).toISOString())}),r=l.append("g").attr("class","context"),c=d3.scale.linear().domain([1,d3.max(n.map(function(t){return t.value}))]).range([2,i]),r.selectAll("rect").data(n.filter(function(t){return t.value>0})).enter().append("rect").attr("transform","translate(0, 10)").attr("x",function(t){return-1+p(t.date)}).attr("width",2).attr("y",function(t){return o/2-c(t.value)}).attr("height",function(t){return 2*c(t.value)}),t=d3.svg.axis().scale(p).orient("bottom"),r.append("g").attr("class","x axis").attr("transform","translate(0, "+o+")").call(t),e.results.is_proper_subset())?(u=6,s=e.results.get("extent")[0],a=e.results.get("extent")[1],r.append("g").attr("class","x brush").append("rect").attr("transform","translate(0, "+(o/2-i)+")").attr("y",0).attr("height",2*i+20).attr("x",p(s)-5).attr("width",p(a)-p(s)+10)):void 0},r}(Backbone.View),c=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.events={"click .fa-search":function(){return this.$("form").submit()},"submit form":function(){var t;return t=this.$("input").val().trim(),e.query.set({q:t.length?t:"*",filters:{},page:0}),this.$("input").blur(),e.results.fetch(),e.stats.fetch(),!1}},r}(Backbone.View),o=function(t){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.initialize=function(){return e.query.on("change",this.render)},r.prototype.render=function(){return this.$el.html(e.query.get("q"))},r}(Backbone.View),g=function(t){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,t),r.prototype.initialize=function(){return e.results.on("change",this.render),$(window).resize(_.debounce(this.render,300)),this.tip=d3.tip().attr("class","tooltip").offset([-10,0]).html(function(t){return t.title})},r.prototype.render=function(){var t,r,n,o,a,i,s,u,c,l,p,d,g,h;return u=25,a=e.results.get("data"),this.$el.html("<svg></svg>"),a.length?(s=this.$el.height()-u,i=.75*s/Config.packing,g=d3.time.scale().domain([d3.min(a.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(a.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([u,this.$el.width()-u]),h=d3.scale.linear().domain(d3.extent(a.map(function(t){return t.pos%Config.packing}))).range([s-i/2-u,i/2+u]),p=d3.select(this.$el.find("svg")[0]),d=this.tip,o=p.append("g").attr("class","context"),r=d3.scale.ordinal().domain(e.categories.toJSON().map(function(t){return t.category})).range(_.range(e.categories.length)),n=d3.scale.linear().domain([0,e.categories.length]).range(["orange","green"]),p.call(d),c=d3.scale.linear().domain([1,d3.max(a.map(function(t){return t.value}))]).range([2,15]),l=Math.floor(Math.random()*a.length),o.selectAll("circle").data(a).enter().append("circle").attr("class",function(t){return"category"+r(t.category)}).attr("data-category",function(t){return r(t.category)}).attr("data-title",function(t){return t.title}).attr("data-id",function(t){return t.id}).attr("transform","translate(0, 10)").attr("fill",function(t){return t.category?n(r(t.category)):"black"}).attr("cx",function(t){return g(t.date)}).attr("cy",function(t){return h(t.pos%Config.packing)+t.v%i-i/2}).attr("r",6).on("mouseover",function(t){return d.show(t,this).style("border-color",n(r(t.category))),o.selectAll("circle.category"+r(t.category)).classed("highlight",!0)}).on("mouseout",function(t){return d.hide(t,this),o.selectAll("circle.highlight").classed("highlight",!1)}).on("click",d.hide).filter(function(t){return l===t.pos}).each(function(t){return d.show(t,this).style("border-color",n(r(t.category)))}),t=d3.svg.axis().scale(g).orient("bottom"),o.append("g").attr("class","x axis").attr("transform","translate(0, "+s+")").call(t)):void 0},r.prototype.events={"mouseleave circle":function(){return this.$("circle.highlight").removeClass("highlight")},"click circle":function(t){return e.selected.set(e.results.get("index")[$(t.target).data("id")])}},r}(Backbone.View),e=e||{},e.query=new u({q:"*"}),e.results=new l,e.stats=new p,e.selected=new Backbone.Model,e.preview=new Backbone.Model,e.categories=new r,$(function(){return new c({el:"header"}),new g({el:"#timeline"}),new d({el:"#summary"}),new a({el:"#selected"}),new s({el:"#prev"}),new i({el:"#next"}),e.categories.fetch({success:function(){return e.results.fetch(),e.stats.fetch()}})})}).call(this);