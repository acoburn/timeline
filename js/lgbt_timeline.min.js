// (c) 2014 Amherst College. Author: Aaron Coburn <acoburn@amherst.edu>
(function(){var t,e,r,n,a,i,s,o,u,c,l,p,d,g,h,f,m={}.hasOwnProperty,y=function(t,e){function r(){this.constructor=t}for(var n in e)m.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},v=function(t,e){return function(){return t.apply(e,arguments)}};r={solr:"/solr/lgbt/select?",search_params:{wt:"json",sort:"start desc",stats:"true","stats.field":"start"},packing:4,rows:30},f=function(t){var e;return e=jQuery.param(_.defaults(t,r.search_params)),""+r.solr+e},n=["January","February","March","April","May","June","July","August","September","October","November","December"],h=function(t,e){var r,a,i;return i=new Date(t),r=new Date(e),a=""+n[i.getUTCMonth()]+" "+i.getUTCDate(),a+=r.getUTCFullYear()===i.getUTCFullYear()?r.getUTCMonth()===i.getUTCMonth()?r.getUTCDate()===i.getUTCDate()?", "+i.getUTCFullYear():" - "+r.getUTCDate()+", "+i.getUTCFullYear():" - "+n[r.getUTCMonth()]+" "+r.getUTCDate()+", "+r.getFullYear():", "+i.getUTCFullYear()+" - "+n[r.getUTCMonth()]+" "+r.getUTCDate()+", "+r.getUTCFullYear()},l=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.offset=function(){return this.get("data").length+this.get("start")},e.prototype.is_proper_subset=function(){var t,e;return t=this.get("extent"),t?(e=t.map(function(t){return t.toISOString()}),e[0]===this.get("min").toISOString()&&e[1]===this.get("max").toISOString()?!1:!0):!1},e.prototype.build_results=function(t,e){return $.get(f({q:t,start:e*r.rows,rows:r.rows}),function(t){return function(e){return t.set(e.response.numFound?{min:new Date(e.stats.stats_fields.start.min),max:new Date(e.stats.stats_fields.start.max),start:e.response.start,count:e.response.numFound,index:_.indexBy(e.response.docs,"id"),extent:d3.extent(e.response.docs.map(function(t){return new Date(t.start)})),data:e.response.docs.map(function(t,e){return{id:t.id,pos:e,v:t._version_,date:new Date(t.start),progress:t.progress,category:_.head(t.category),title:t.title}}).reverse()}:{min:null,max:null,start:0,count:0,index:{},data:[],extent:null})}}(this))},e}(Backbone.Model),p=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.build_summary=function(t){return $.get(f({q:t,rows:0,facet:!0,"facet.field":"year","facet.mincount":1}),function(t){return function(e){var r;return r=e.facet_counts.facet_fields.year.map(function(t){return parseInt(t,10)}),t.set({data:_.zip.apply(null,_.partition(r,function(t,e){return e%2===0}))})}}(this))},e}(Backbone.Model),u=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.defaults={q:null,filters:[],page:0},e.prototype.prev=function(){return this.set("page",this.get("page")+1)},e.prototype.next=function(){return this.set("page",this.get("page")-1)},e}(Backbone.Model),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e.prototype.model=Backbone.Model,e.prototype.parse=function(t){var e;return e=t.facet_counts.facet_fields.category.filter(function(t,e){return e%2===0}),e.map(function(t){return{catagory:t}})},e.prototype.url=f({q:"*",rows:0,facet:!0,"facet.field":"category","facet.mincount":1}),e}(Backbone.Collection),o=function(e){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.initialize=function(){return t.results.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.results.offset()<t.results.get("count")?$("#prev-tpl").html():"<div></div>")},r.prototype.events={click:function(){return t.results.offset()<t.results.get("count")&&t.query.prev(),t.results.build_results(t.query.get("q"),t.query.get("page"))}},r}(Backbone.View),s=function(e){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.initialize=function(){return t.results.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.results.get("start")>0?$("#next-tpl").html():"<div></div>")},r.prototype.events={click:function(){return t.results.get("start")>0&&t.query.next(),t.results.build_results(t.query.get("q"),t.query.get("page"))}},r}(Backbone.View),i=function(e){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.initialize=function(){return t.selected.on("change",this.render)},r.prototype.render=function(){var e;return t.selected.get("id")?(e=t.selected.toJSON(),e.date_string=h(e.start,e.end),e.locations=_.zip(e.municipality,e.country,e.region).map(function(t){return _.compact(t).join(", ")}),e.media_uri&&_.head(e.media_uri).match(/\.jpe?g/i)&&(e.media=[{url:_.head(e.media_uri).replace(/image:/,""),caption:e.media_caption,credit:e.media_credit,title:e.media_title}]),e.sources=_.zip(e.source_citation,e.source_title,e.source_url).map(function(t){return{citation:t[0]||t[1],title:t[1],url:t[2]}}),this.$el.html(Mustache.render($("#selected-modal-tpl").html(),e)),this.$(".modal").modal({show:!0,backdrop:!0})):this.$el.html("")},r.prototype.events={"hidden.bs.modal .modal":function(){return t.selected.clear()}},r}(Backbone.View),d=function(e){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.initialize=function(){return t.results.on("change:extent",this.render),t.stats.on("change",this.render),$(window).resize(_.debounce(this.render,300))},r.prototype.render=function(){var e,r,n,a,i,s,o,u,c,l,p,d;return t.stats.get("data")&&(s=15,n=t.stats.get("data").map(function(t){return{date:new Date(t[0],1),value:t[1]}}),this.$el.html("<svg></svg>"),l=d3.select(this.$el.find("svg")[0]),a=this.$el.height()-25,p=d3.time.scale().domain([d3.min(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(n.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([20,this.$el.width()-20]),d=d3.scale.linear().domain([0,d3.max(n.map(function(t){return t.value}))]).range([a,0]),r=l.append("g").attr("class","context"),c=d3.scale.linear().domain([1,d3.max(n.map(function(t){return t.value}))]).range([2,s]),r.selectAll("rect").data(n.filter(function(t){return t.value>0})).enter().append("rect").attr("transform","translate(0, 10)").attr("x",function(t){return-1+p(t.date)}).attr("width",2).attr("y",function(t){return a/2-c(t.value)}).attr("height",function(t){return 2*c(t.value)}),e=d3.svg.axis().scale(p).orient("bottom"),r.append("g").attr("class","x axis").attr("transform","translate(0, "+a+")").call(e),t.results.is_proper_subset())?(u=6,o=t.results.get("extent")[0],i=t.results.get("extent")[1],r.append("g").attr("class","x brush").append("rect").attr("transform","translate(0, "+(a/2-s)+")").attr("y",0).attr("height",2*s+20).attr("x",p(o)-5).attr("width",p(i)-p(o)+10)):void 0},r}(Backbone.View),c=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.events={"click .fa-search":function(){return this.$("form").submit()},"submit form":function(){var e;return e=this.$("input").val().trim(),t.query.set({q:e.length?e:"*",filters:[],page:0}),this.$("input").blur(),t.results.build_results(t.query.get("q"),0),t.stats.build_summary(t.query.get("q")),!1}},r}(Backbone.View),a=function(e){function r(){return this.render=v(this.render,this),r.__super__.constructor.apply(this,arguments)}return y(r,e),r.prototype.initialize=function(){return t.query.on("change",this.render)},r.prototype.render=function(){return this.$el.html(t.query.get("q"))},r}(Backbone.View),g=function(e){function n(){return this.render=v(this.render,this),n.__super__.constructor.apply(this,arguments)}return y(n,e),n.prototype.initialize=function(){return t.results.on("change",this.render),$(window).resize(_.debounce(this.render,300)),this.tip=d3.tip().attr("class","tooltip").offset([-10,0]).html(function(t){return t.title})},n.prototype.render=function(){var e,n,a,i,s,o,u,c,l,p,d,g,h,f;return c=25,s=t.results.get("data"),this.$el.html("<svg></svg>"),s.length?(u=this.$el.height()-c,o=.75*u/r.packing,h=d3.time.scale().domain([d3.min(s.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()-1,t.date.getUTCDate())})),d3.max(s.map(function(t){return new Date(t.date.getUTCFullYear(),t.date.getUTCMonth()+1,t.date.getUTCDate())}))]).range([c,this.$el.width()-c]),f=d3.scale.linear().domain(d3.extent(s.map(function(t){return t.pos%r.packing}))).range([u-o/2-c,o/2+c]),d=d3.select(this.$el.find("svg")[0]),g=this.tip,i=d.append("g").attr("class","context"),n=d3.scale.ordinal().domain(t.categories.toJSON().map(function(t){return t.category})).range(_.range(t.categories.length)),a=d3.scale.linear().domain([0,t.categories.length]).range(["orange","green"]),d.call(g),l=d3.scale.linear().domain([1,d3.max(s.map(function(t){return t.value}))]).range([2,15]),p=Math.floor(Math.random()*s.length),i.selectAll("circle").data(s).enter().append("circle").attr("class",function(t){return"category"+n(t.category)}).attr("data-category",function(t){return n(t.category)}).attr("data-title",function(t){return t.title}).attr("data-id",function(t){return t.id}).attr("transform","translate(0, 10)").attr("fill",function(t){return t.category?a(n(t.category)):"black"}).attr("cx",function(t){return h(t.date)}).attr("cy",function(t){return f(t.pos%r.packing)+t.v%o-o/2}).attr("r",6).on("mouseover",function(t){return g.show(t,this).style("border-color",a(n(t.category))),i.selectAll("circle.category"+n(t.category)).classed("highlight",!0)}).on("mouseout",function(t){return g.hide(t,this),i.selectAll("circle.highlight").classed("highlight",!1)}).on("click",g.hide).filter(function(t){return p===t.pos}).each(function(t){return g.show(t,this).style("border-color",a(n(t.category)))}),e=d3.svg.axis().scale(h).orient("bottom"),i.append("g").attr("class","x axis").attr("transform","translate(0, "+u+")").call(e)):void 0},n.prototype.events={"mouseleave circle":function(){return this.$("circle.highlight").removeClass("highlight")},"click circle":function(e){return t.selected.set(t.results.get("index")[$(e.target).data("id")])}},n}(Backbone.View),t={query:new u({q:"*"}),results:new l,stats:new p,selected:new Backbone.Model,preview:new Backbone.Model,categories:new e},$(function(){return new c({el:"header"}),new g({el:"#timeline"}),new d({el:"#summary"}),new i({el:"#selected"}),new o({el:"#prev"}),new s({el:"#next"}),t.categories.fetch({success:function(){return t.results.build_results(t.query.get("q"),t.query.get("page")),t.stats.build_summary(t.query.get("q"))}})})}).call(this);